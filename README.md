# SFA/CRM Analytics Dashboard v2.3

モダンでスタイリッシュなダークテーマのSFA/CRMダッシュボード。フルHD (1920x1080) に最適化された2タブ構成。

## 特徴

- 🎨 **ダークテーマUI**: 洗練されたダークモードデザイン
- 📊 **2タブ構成**: ファネル分析と売上・獲得分析
- 📱 **レスポンシブ対応**: フルHD最適化
- ⚡ **高速パフォーマンス**: モジュール化されたアーキテクチャ
- 🔄 **リアルタイム更新**: インタラクティブなデータ可視化
- ♿ **アクセシビリティ対応**: WCAG 2.1 AA準拠
- 📈 **インタラクティブなスパークライン**: ツールチップ付きミニグラフ

## 必要な環境

- Python 3.11以上
- 以下のパッケージ:

```bash
dash==2.18.2
plotly==5.24.1
dash-bootstrap-components==1.6.0
pandas==2.2.0
numpy==1.26.0
openpyxl==3.1.2
```

## インストール

```bash
# リポジトリのクローン
git clone [repository-url]
cd sfa-crm-dashboard

# 仮想環境の作成（推奨）
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 依存関係のインストール
pip install -r requirements.txt
```

## プロジェクト構成

```
sfa-crm-dashboard/
├── main.py                 # メインアプリケーション
├── config.py              # 設定・定数
├── data_manager.py        # データ処理
├── components/            # UIコンポーネント
│   ├── __init__.py
│   ├── cards.py          # カードコンポーネント
│   ├── charts.py         # グラフコンポーネント
│   └── header.py         # ヘッダーコンポーネント
├── layouts/              # レイアウト定義
│   ├── __init__.py
│   ├── tab1_funnel.py    # ファネル分析タブ
│   └── tab2_revenue.py   # 売上・獲得分析タブ
├── callbacks/            # コールバック処理
│   ├── __init__.py
│   ├── tab1_callbacks.py # Tab1コールバック
│   └── tab2_callbacks.py # Tab2コールバック
├── assets/               # 静的ファイル
│   ├── style.css         # グローバルCSS
│   └── tab1-specific.css # Tab1専用CSS
├── CLAUDE.md             # AI開発支援ドキュメント
├── pdca_2025.xlsx        # サンプルデータ
└── README.md            # このファイル
```

## 使い方

1. **アプリケーションの起動**
   ```bash
   python main.py
   ```
   ブラウザで `http://localhost:8050` にアクセス

2. **データのアップロード**
   - ヘッダーの「データ更新」ボタンをクリック
   - Excel形式のPDCAデータ（'25年PDCA'シート）を選択

3. **操作方法**
   - **月選択**: ドロップダウンから対象月を選択
   - **計画比/計画差**: 表示する指標タイプを切り替え
   - **累月/単月**: 期間タイプを切り替え
   - **タブ切り替**: ファネル分析と売上・獲得分析を切り替え

## タブ詳細

### Tab1: ファネル分析
- **メトリクスバー**: 主要5指標の概要表示（複合グラフ）
  - 計画比/計画差の切り替え対応
  - 計画差選択時の線グラフ表示
- **ファネルビジュアル**: 5チャネル×5ステージのPlotlyファネル表示
  - 計画比に応じたヒートマップカラー表示
  - インタラクティブなホバーツールチップ
  - チャネル別ステージ名表示（リード/アプローチ）
  - コンパクトな横並びヘッダーレイアウト
- **経路別CV率トレンド**: 
  - ステージ間のCV率フィルタ（to 商談、to 具体検討、to 内諾、to 獲得）
  - カード選択による「ステージ別CV率トレンド」への連動フィルタ
  - インタラクティブなスパークライン（ツールチップ付き）
  - 実績データのある月まで表示
- **ステージ別CV率トレンド**: 経路別トレンドからのフィルタ連動対応

### Tab2: 売上・獲得分析
- **トレンドグラフ**: 売上高・獲得数の月次推移
  - 計画/実績の棒グラフと達成率ライン
  - ヒートマップカラーによる達成率表示
- **KPIカード**: 経路別・プラン別のパフォーマンス一覧
  - 実績と計画のスパークライン
  - ツールチップによる詳細表示
  - 計画比/計画差の切り替え表示
  - カードクリックによるフィルタ機能
- **継続率分析**: チャネル別継続率の可視化
- **客単価分析**: チャネル別客単価表示（カードクリックフィルタ機能付き）
- **売上高構成分析**: 選択月の経路別売上構成
  - 実績・計画比較の横棒グラフ
  - 売上高順でのソート表示
  - オレンジ系とグレー系の調和したカラーパレット
- **インサイト&アラート**: 重要な気づきと警告（インサイトセクションとの50:50分割表示）

## カスタマイズ

### カラーテーマの変更
`config.py`の`DARK_COLORS`辞書を編集:

```python
DARK_COLORS = {
    'primary_orange': '#ff6b35',  # メインカラー
    'bg_dark': '#0f1419',         # 背景色
    # ...
}
```

### レイアウトの調整
`config.py`の`LAYOUT`辞書を編集:

```python
LAYOUT = {
    'max_width': '1920px',
    'header_height': '48px',
    # ...
}
```

## トラブルシューティング

### よくある問題

1. **データが表示されない**
   - Excelファイルに'25年PDCA'シートが存在することを確認
   - データ範囲が正しいことを確認（config.pyのEXCEL_STRUCTURE）

2. **グラフが更新されない**
   - ブラウザのキャッシュをクリア
   - アプリケーションを再起動

3. **エラーメッセージが表示される**
   - コンソールログを確認
   - data_manager.pyのエラーハンドリングを確認

4. **スパークラインが0の水平線になる**
   - チャネル名マッピングの問題（v2.4.0で修正済み）
   - 累月データの単月変換ロジック（v2.4.0で修正済み）
   - ブラウザキャッシュのクリアを試行

5. **ファネルチャートのホバーが表示されない**
   - v2.4.0でPlotlyファネルに完全移行済み
   - CSS z-indexやpointer-events設定の確認

## 開発者向け情報

### 新しいコンポーネントの追加

1. `components/`に新しいファイルを作成
2. 必要な関数を実装
3. 該当するレイアウトファイルでインポート

### 新しいコールバックの追加

1. `callbacks/`の該当ファイルに追加
2. `register_tabX_callbacks()`関数内で定義
3. 必要に応じて新しいOutputを追加

### パフォーマンス最適化

- 大量データの場合は`dcc.Store`の使用を検討
- グラフの`config={'displayModeBar': False}`で不要なツールバーを非表示
- コールバックの依存関係を最小限に

## ライセンス

このプロジェクトは社内利用を目的としています。

## 既知の制限事項

- **法人チャネル**: ①ステージ（リード・アプローチ）のデータは存在しない
- **インサイト&アラート**: 現在ハードコーディングされた条件で表示
- **データ更新**: リアルタイムではなく、手動でのアップロードが必要

## 主な技術仕様

### UI/UX
- **CSSカスタムプロパティ**: デザイントークンによる一元管理
- **ユーティリティCSS**: flexbox、grid、spacingクラス
- **レスポンシブ対応**: clamp()関数による動的サイズ調整
- **アクセシビリティ**: ARIA属性、適切なコントラスト比
- **インタラクティブ機能**: KPIカードクリックフィルタ、ホバー詳細表示

### データ処理
- **パーセンテージ**: すべて小数点以下四捨五入
- **スパークライン**: 実績データのある月まで表示、計画は12月まで
- **単月変換**: 獲得数の累月データを単月データに自動変換
- **チャネル名正規化**: 表示名（新規web）⇔内部名（新規（WEB））の自動マッピング
- **KPIカード**: 値が0でも常に表示、クリックでフィルタリング
- **売上高構成**: 選択月のみ表示、売上高順でソート
- **用語統一**: 全体で"実績"/"計画"に統一

### グラフ機能
- **積上棒グラフ**: 実績・計画の横並び比較
- **カラーパレット**: オレンジ系（#ff6b35系）とグレー系の調和
- **フィルタ連動**: Tab2専用フィルタによる独立した絞り込み

## レイアウト問題の対応と今後の開発注意点

### Tab2空白問題の対応内容

#### 問題の詳細
Tab2（売上・獲得分析）で以下の問題が発生していました：
- セクション間に不自然な空白が発生
- 設計意図の30:45:25の比率が維持されない
- 内容量に応じてセクションサイズが変動

#### 根本原因
1. **flex-shrink設定**: `flex: 0 1 30%` のshrink=1により内容が少ない場合に縮小
2. **minHeight不足**: カードとセクションの最小高さ制約が不十分
3. **CSS継承問題**: 親子要素間でのスタイル継承の不整合

#### 実施した修正
1. **Flex設定の固定化**
   ```python
   # 修正前: flex: '0 1 30%' (shrink可能)
   # 修正後: flex: '0 0 30%' (shrink禁止)
   ```

2. **階層的なminHeight設定**
   - 上段セクション: 250px
   - 中段セクション: 350px  
   - 下段セクション: 200px
   - 個別カード: 230px/180px

3. **CSS優先度の強制**
   ```css
   .revenue-acquisition-grid {
       flex: 0 0 30% !important;
       min-height: 250px !important;
   }
   ```

### 今後の改修・開発に向けた注意点

#### レイアウト設計
1. **固定比率レイアウトでは必ずflex-shrink: 0を使用**
   - 内容量に関係なくサイズを維持したい場合は必須
   - `flex: 0 0 XX%` の形式を推奨

2. **minHeightの階層的設定**
   - 親コンテナから子要素まで一貫した制約を設定
   - セクション > カードコンテナ > 個別カードの順に設定

3. **height: 100%の適切な使用**
   - 親要素に明確な高さ制約がある場合のみ有効
   - flexコンテナ内では`flex: 1`の使用も検討

#### CSS設計指針
1. **!importantの戦略的使用**
   - レイアウトの基幹部分にのみ使用
   - 通常のスタイリングでは避ける
   - 使用する場合はコメントで理由を明記

2. **CSS変数の活用**
   ```css
   --header-height: 48px;
   --section-gap: 16px;
   ```
   - 一貫性のある値管理
   - メンテナンス性の向上

3. **レスポンシブ対応**
   - Full HD (1920x1080) を基準に設計
   - 1366px以下でのフォールバック設定
   - vh/vw単位の適切な使用

#### コンポーネント開発
1. **スタイル定義の場所**
   - レイアウト系: layouts/ファイル内で定義
   - 見た目系: config.pyのDARK_COLORSを使用
   - 動的スタイル: コンポーネント内で定義

2. **デバッグ方法**
   - ブラウザの開発者ツールでFlexboxレイアウトを確認
   - 計算されたスタイルで実際の適用値を確認
   - CSS継承の流れを追跡

3. **テスト観点**
   - 空データでのレイアウト崩れ確認
   - 大量データでのスクロール動作確認
   - 異なる画面サイズでの表示確認

#### パフォーマンス考慮
1. **不要な再レンダリング防止**
   - スタイルオブジェクトの事前定義
   - コールバックの依存関係最小化

2. **CSS計算の最適化**
   - calc()の過度な入れ子を避ける
   - 固定値で済む場合は固定値を使用

## 更新履歴

- **v2.4.0** (2025/06/18):
  - **スパークライン表示問題の修正**: 
    - Tab2 KPIカードのスパークラインデータ不整合を解決
    - 獲得数データの累月→単月変換ロジック改善
    - チャネル名マッピング問題の修正（表示名vs内部名）
  - **ファネルチャート対話機能の完全実装**:
    - HTMLファネルからPlotlyファネルへの全面移行
    - 計画比に応じたヒートマップカラー表示
    - ホバーツールチップの正常動作
    - 計画差線グラフ表示機能の追加
  - **フィルタ機能の強化**:
    - Tab1「経路別CV率トレンド」→「ステージ別CV率トレンド」連動
    - チャネル別ステージ名表示（リード/アプローチ）
    - 日本語UI表記の改善（"to 商談"等）
- **v2.3.0** (2025/06/18):
  - 売上高構成分析グラフの追加（実績・計画比較の横棒グラフ）
  - Tab2 KPIカードクリックフィルタ機能の実装
  - 用語統一対応（"実績値"→"実績"、"予算"→"計画"）
  - インサイトセクションとのレイアウト調整（50:50分割）
- **v2.2.0** (2025/06/18):
  - Tab2レイアウト問題の完全修正
  - EXEファイル化対応（PyInstaller設定追加）
  - 開発ガイドラインの充実
- **v2.1.0** (2024/06/17): 
  - アクセシビリティ対応（WCAG 2.1 AA準拠）
  - スパークラインのツールチップ追加
  - 法人チャネルの特殊処理対応
  - パーセンテージ表示の統一（小数点以下四捨五入）
- **v2.0.0** (2024/06/16): 完全リニューアル、ダークテーマ採用
- **v1.5.0** (2025/06/11): Pure CSS Grid実装
- **v1.4.0** (2025/06/10): 技術的安定性向上
- **v1.3.0** (2025/06/09): ステージ統合機能追加

---

開発・保守に関する質問は開発チームまでお問い合わせください。